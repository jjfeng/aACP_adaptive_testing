import os

from os.path import join
from nestly.scons import SConsWrap
from nestly import Nest
from SCons.Script import Environment, Command, AddOption

Import('env')
localenv = env.Clone()

# Set up state
nest = SConsWrap(Nest(), localenv['output'], alias_environment=localenv)

RUN_STATUS = localenv['clusters']
# I've run 10 seeds so far
NUM_SEEDS = localenv['num_seeds']
REUSE_ITERS = 20

nest.add(
    'num_p',
    [10],
    label_func=lambda c: "num_p_%d" % c)

nest.add(
    'init_beta',
    [1],
    label_func=lambda c: "beta_%.2f" % c)

nest.add(
    'fwer',
    [
        0.1,
    ],
    label_func=lambda c: "fwer_%.3f" % c)

nest.add(
    'init_train_n',
    [
         80,
    ],
    label_func=lambda c: "train_%d" % c)

nest.add(
    'train_batch_n',
    [
         20,
    ],
    label_func=lambda c: "batch_%d" % c)

nest.add(
    'reuse_test_n',
    [200],
    label_func=lambda c: "test_%d" % c)

nest.add(
    'model_type',
    [
        #"Logistic",
	# NOTE: turns out there is too much stochasticity in the normal sklearn
        # tree model implementations that adding a single observation changes the models
        # drastically, which makes them unsuitable for graphical_par
        "GBT",
    ])

nest.add(
    'model_sim',
    [
        "online",
        #"online_bad",
    ])

@nest.add_target_with_env(localenv)
def create_modeler(env, outdir, c):
    cmd = [
        'python create_modeler.py',
        '--model-type',
        c['model_type'],
        '--simulation',
        c['model_sim'],
	'--out ${TARGETS[0]}'
    ]
    return env.Command(
        [
            join(outdir, 'model.pkl')],
        [],
        ' '.join(map(str, cmd)))



nest.add(
    'meta_seed',
    [
	0,
    ],
    label_func=lambda c: "meta_seed_%d" % c)

nest.add_aggregate("summary_res", list)
nest.add(
    'seed',
    range(NUM_SEEDS),
    label_func=lambda c: "seed_%d" % c)


@nest.add_target_with_env(localenv)
def generate_data(env, outdir, c):
    cmd = [
        'python generate_data_single_pop.py',
        '--meta-seed',
        c['meta_seed'],
        '--data-seed',
        c['seed'],
        '--sparse',
        c['num_p'],
        '--p',
        c['num_p'],
        '--init-train-n',
        c['init_train_n'] * (2 if c['model_type'] == "GBT" else 1),
        '--train-batch-n',
        c['train_batch_n'],
        '--train-iters',
        REUSE_ITERS,
        '--init-reuse-test-n',
        c['reuse_test_n'],
        '--init-sparse-beta',
        c['init_beta'],
        '--perturb-beta',
        c['init_beta'] * 0.2,
        '--test-n 4000',
	'--out ${TARGETS[0]}',
	'--log-file ${TARGETS[1]}',
    ]
    return env.Command(
        [
            join(outdir, 'data.pkl'),
            join(outdir, 'data_log.txt')],
        [],
        ' '.join(map(str, cmd)))

nest.add(
    'dp_mech',
    [
        "bonferroni",
        "graphical_bonf",
        "graphical_ffs",
        "graphical_parallel",
    ])
@nest.add_target_with_env(localenv)
def create_dp(env, outdir, c):
    targets = [join(outdir, 'dp_mech.pkl')]
    scratch_file = join("simulation_reuse", outdir, "scratch.txt")
    success_ratio = 0.6 if "parallel" in c['dp_mech'] else 0.8

    cmd = [
        'python create_dp_mechanism.py',
        '--parallel-ratio 0.7' if "parallel" in c['dp_mech'] else '',
        '--first-pres-weight 0.5' if "parallel" in c['dp_mech'] else '',
        '--success-weight %f' % success_ratio if "graphical" in c['dp_mech'] else '',
        '--alpha',
        c['fwer'],
        '--dp-mech',
        c['dp_mech'],
	'--scratch %s' % scratch_file if "parallel" in c['dp_mech'] else '',
	'--out ${TARGETS[0]}'
    ]
    return env.Command(
        [
            join(outdir, 'dp_mech.pkl')],
        [],
        ' '.join(map(str, cmd)))

@nest.add_target_with_env(localenv)
def run_experiment(env, outdir, c):
    cmd = [
        'python main.py',
        '--seed',
	c['seed'],
        '--max-iter',
        REUSE_ITERS,
	'--data ${SOURCES[0]}',
	'--model ${SOURCES[1]}',
	'--dp-mech ${SOURCES[2]}',
	'--log ${TARGETS[0]}',
	'--out-csv ${TARGETS[1]}',
	#'--plot ${TARGETS[1]}'
    ]
    targets = [
            join(outdir, 'log.txt'),
            join(outdir, 'res.csv'),
    ]
    c['summary_res'].append(targets[1])
    return env.Command(
        targets,
        [
            c["generate_data"][0],
            c["create_modeler"][0],
            c["create_dp"][0],
        ],
        ' '.join(map(str, cmd)))

nest.pop("seed")

@nest.add_target_with_env(localenv)
def plot_avg(env, outdir, c):
    cmd = [
        'python plot_simulation_reuse.py',
	'--results',
        ",".join(["simulation_reuse/%s" % r for r in c['summary_res']]),
	'--plot-file ${TARGETS[0]}',
    ]
    return env.Command(
        [
            join(outdir, 'res_summary.png'),
        ],
        c["summary_res"],
        ' '.join(map(str, cmd)))
